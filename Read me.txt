This is library code, very complex code